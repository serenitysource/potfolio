
<div align="center">
<a href="https://github.serenity.energy" style="font-size:1.2em; font-weight:bold; color:#2d8cff;">
ğŸ“– View Full Documentation Site: https://github.serenity.energy
</a>
</div>
<div align="center">
<h1>ğŸ” <span style="color:#2d8cff">End-to-End Provenance Flow</span> ğŸ”—</h1>
<h3>Cryptographic Proof Chain for Energy Token Integrity</h3>
<img src="https://img.shields.io/badge/Blockchain-Anchored-blue?logo=ethereum" />
<img src="https://img.shields.io/badge/Provenance-Verified-green?logo=verified" />
<img src="https://img.shields.io/badge/Audit-Ready-purple?logo=shield" />
<img src="https://img.shields.io/badge/Merkle-Trees-orange?logo=tree" />
</div>

---

## ğŸ¯ 1. System Goal (What Must Be Proven)

This system must provide three things at once:

<table>
<tr>
<td width="33%" align="center">
    <h3>âš¡ Real-time UX</h3>
    <p>Users can transfer <span style="color:#2ecc71"><strong>ERGON</strong></span>/<span style="color:#9b59b6"><strong>CARBON</strong></span> freely between wallets and bridge quickly.</p>
</td>
<td width="33%" align="center">
    <h3>ğŸ”’ Strong Provenance</h3>
    <p>Auditors can verify that <span style="color:#9b59b6"><strong>CARBON</strong></span> supply came from real device readings with integrity chain back to device metering database.</p>
</td>
<td width="33%" align="center">
    <h3>ğŸ“Š Minimal On-Chain Load</h3>
    <p>On-chain storage limited to anchors (cryptographic commitments) while detailed per-minute data remains off-chain.</p>
</td>
</tr>
</table>

<div style="background-color:#e7f3ff; padding:15px; border-radius:8px; border-left:4px solid #2d8cff; margin:20px 0;">
<strong>ğŸ’¡ Key Idea:</strong> Keep minute-level readings in the database, but anchor each reading on-chain via a deterministic <code>canonical_reading_hash</code> and mint/burn events that reference it.
</div>

---

## ğŸ§© 2. Components and Responsibilities

### ğŸŸ  A. HEPEK Device Runtime (`contract.py`)

- âœ… Reads meter deltas (minute granularity).
- âœ… Builds a canonical reading envelope.
- âœ… Computes a deterministic <code>canonical_reading_hash</code> (<code>bytes32</code>, <code>keccak256</code>).
- âœ… Calls <code style="color:#2ecc71">ErgonEnergy.SC_Power_OUT_Alloc(produced, exported, canonical_reading_hash)</code> on-chain.
- âœ… Persists the same hash and tx metadata in DB/MQTT for later audit reconstruction.

### ğŸŸ£ B. Energy Accounting Contract (`ErgonEnergy.sol`)

- âœ… Receives readings and enforces anti-replay (e.g., <code>usedReading[readingHash]</code>).
- âœ… Emits audit events that include <code>canonical_reading_hash</code> and derived allocations.
- âœ… Calls token contracts to mint/burn:
  - <code style="color:#2ecc71">Ergon.increaseSupply(...)</code>
  - <code style="color:#9b59b6">Carbon.increaseSupply(...)</code>
  - Burn calls for imports or settlement (depending on the accounting rules).

### ğŸŸ¢ C. ERC-20 Tokens (`Carbon.sol`, `Ergon.sol`)

- âœ… Hold balances and support normal ERC-20 transfers.
- âœ… <code>increaseSupply(to, amount)</code> is the core mint entrypoint (in <code style="color:#9b59b6">Carbon.sol</code> it is typically restricted to <code>onlyEngine</code>).
- âœ… Burning is also restricted to <code>onlyEngine</code> (e.g., <code>burnFrom(...)</code>).

<div style="background-color:#fff9e6; padding:15px; border-radius:8px; border-left:4px solid #f39c12; margin:20px 0;">
<strong>ğŸ“ Design Note:</strong> This separation keeps token contracts simple while ensuring that all "meaning" (mint/burn justification) is derived from <code>ErgonEnergy</code> events.
</div>

---

## ğŸ”‘ 3. Canonical `canonical_reading_hash` (The Audit Anchor)

### 3.1 What the Hash Is (And Why It Matters)

<code>canonical_reading_hash</code> is the **cryptographic join key** across:

<table style="width:100%; margin:20px 0;">
<tr>
<td width="33%" style="background-color:#e8f5e9; padding:15px; text-align:center;">
    <strong>ğŸ“Š Off-Chain</strong><br/>
    Raw reading stored in DB/MQTT
</td>
<td width="33%" style="background-color:#e3f2fd; padding:15px; text-align:center;">
    <strong>â›“ï¸ On-Chain TX</strong><br/>
    Transaction that submitted reading
</td>
<td width="33%" style="background-color:#f3e5f5; padding:15px; text-align:center;">
    <strong>ğŸ¯ Audit Events</strong><br/>
    Events describing supply derivation
</td>
</tr>
</table>

**It exists to support:**

- ğŸš« **Anti-replay** - The engine can reject a duplicate hash
- ğŸ”— **Cryptographic link** - Between telemetry records and EVM state transitions
- âœ… **Deterministic audit** - Recompute the hash from DB data and match it to chain events

<div style="background-color:#fff3e0; padding:12px; border-radius:6px; margin:15px 0;">
<strong>ğŸ“Œ Note:</strong> Solidity code may refer to this value as <code>readingHash</code> or <code>reading_hash</code> as a parameter name; this document consistently uses <code>canonical_reading_hash</code> for clarity.
</div>

### 3.2 Deterministic Hashing: Prefer the "Strong" Version

Two hashing approaches typically exist:

<table style="width:100%; margin:20px 0;">
<tr>
<td width="50%" style="background-color:#ffebee; padding:20px;">
    <h4>âš ï¸ Minimal Payload</h4>
    <code>make_reading_hash(...)</code>
    <p>Basic hash without normalization</p>
    <p style="color:#e74c3c;"><strong>NOT RECOMMENDED</strong></p>
</td>
<td width="50%" style="background-color:#e8f5e9; padding:20px;">
    <h4>âœ… Strong & Deterministic</h4>
    <code>make_deterministic_reading_hash(...)</code>
    <p style="color:#2ecc71;"><strong>RECOMMENDED</strong></p>
    <p>Typed + normalized + schema + direction + factor</p>
</td>
</tr>
</table>

The **deterministic version** is safer because it enforces:

- âœ… Device ID normalization
- âœ… Timestamp as an integer slot (no format ambiguity)
- âœ… Produced/exported values as integers (avoids float drift)
- âœ… A schema/version marker
- âœ… Canonical JSON encoding with stable separators

<div style="background-color:#e7f3ff; padding:15px; border-radius:8px; border-left:4px solid #2d8cff; margin:20px 0;">
<strong>ğŸ¯ Auditor Requirement:</strong> The digest can be reproduced exactly from the same source data.
</div>

### 3.3 Should `canonical_reading_hash` Be Included in MQTT Payload?

**Yes.** The intended pattern is:

<table style="width:100%; margin:20px 0;">
<tr>
<td width="50%" style="background-color:#e3f2fd; padding:15px;">
    <h4>â›“ï¸ On-Chain</h4>
    <p>Store/emit <code>canonical_reading_hash</code></p>
</td>
<td width="50%" style="background-color:#e8f5e9; padding:15px;">
    <h4>ğŸ“Š Off-Chain</h4>
    <p>Store:</p>
    <ul>
        <li><code>canonical_reading_hash</code> (same value)</li>
        <li>Original meter fields</li>
        <li>Transaction metadata (<code>tx_hash</code>, block/log position)</li>
    </ul>
</td>
</tr>
</table>

**Recommendation: Audit-Friendly DB Fields Per Reading**

<table style="width:100%; border-collapse:collapse; margin:20px 0;">
<tr style="background-color:#2d8cff; color:white;">
    <th style="padding:10px; text-align:left;">#</th>
    <th style="padding:10px; text-align:left;">Field Name</th>
    <th style="padding:10px; text-align:left;">Type</th>
    <th style="padding:10px; text-align:left;">Description</th>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:8px;">1</td>
    <td style="padding:8px;"><code>canonical_reading_hash</code></td>
    <td style="padding:8px;">bytes32 hex</td>
    <td style="padding:8px;">Primary cryptographic anchor</td>
</tr>
<tr>
    <td style="padding:8px;">2</td>
    <td style="padding:8px;"><code>device_id</code></td>
    <td style="padding:8px;">string</td>
    <td style="padding:8px;">Normalized lowercase address</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:8px;">3</td>
    <td style="padding:8px;"><code>timestamp_slot</code></td>
    <td style="padding:8px;">int</td>
    <td style="padding:8px;">Epoch-minute integer</td>
</tr>
<tr>
    <td style="padding:8px;">4-7</td>
    <td style="padding:8px;"><code>produced_power</code>, <code>export_power</code>, <code>factor</code>, <code>direction</code></td>
    <td style="padding:8px;">numeric</td>
    <td style="padding:8px;">Meter reading values</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:8px;">8</td>
    <td style="padding:8px;"><code>chain_id</code></td>
    <td style="padding:8px;">int</td>
    <td style="padding:8px;">Blockchain identifier</td>
</tr>
<tr>
    <td style="padding:8px;">9</td>
    <td style="padding:8px;"><code>tx_hash</code></td>
    <td style="padding:8px;">bytes32 hex</td>
    <td style="padding:8px;">Transaction hash</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:8px;">10</td>
    <td style="padding:8px;"><code>block_number</code></td>
    <td style="padding:8px;">int</td>
    <td style="padding:8px;">Block height</td>
</tr>
<tr>
    <td style="padding:8px;">11</td>
    <td style="padding:8px;"><code>log_index</code></td>
    <td style="padding:8px;">int</td>
    <td style="padding:8px;">Index of engine audit event log</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:8px;">12</td>
    <td style="padding:8px;"><code>ergon_energy_contract</code></td>
    <td style="padding:8px;">address</td>
    <td style="padding:8px;">Engine contract address</td>
</tr>
<tr>
    <td style="padding:8px;">13</td>
    <td style="padding:8px;"><code>prev_hash</code></td>
    <td style="padding:8px;">bytes32 hex</td>
    <td style="padding:8px;">Optional: previous reading hash (see Section 9)</td>
</tr>
</table>

<div style="background-color:#e8f5e9; padding:15px; border-radius:8px; border-left:4px solid #2ecc71; margin:20px 0;">
<strong>âœ… Result:</strong> This makes provenance reconstruction <strong>deterministic and fast</strong>.
</div>

---

## ğŸ”„ 4. End-to-End Flow (Minute Reading â†’ Tokens Minted)

### 4.1 High-Level Block Diagram

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      MQTT/DB write (payload + canonical_reading_hash + tx_meta)
â”‚   HEPEK      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  device      â”‚                                                            â”‚
â”‚ contract.py  â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
       â”‚ SC_Power_OUT_Alloc(produced, exported, canonical_reading_hash)     â”‚
       â–¼                                                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         mints/burns              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  ErgonEnergy.sol  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  Carbon.sol    â”‚    â”‚
â”‚  (engine + audit) â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  Ergon.sol     â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚                                                                    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ emits audit events (canonical_reading_hash anchored) â”€â”€â”€â”€â”€â”˜
```

### 4.2 Detailed Step-by-Step Sequence

<details>
<summary><strong>ğŸ“‹ Click to Expand: Complete Transaction Flow</strong></summary>

1. **ğŸ—ï¸ Device Creates Envelope + Hash**
   - Build a canonical envelope with `device_id`, `timestamp`, `direction`, `produced/exported`, and `factor`.
   - Compute `canonical_reading_hash = make_deterministic_reading_hash(envelope)`.

2. **ğŸ“¤ Device Submits Reading to Chain**
   - Invoke `SC_Power_OUT_Alloc(produced_power, export_power, canonical_reading_hash)` (signed by the device key).

3. **ğŸ’¾ Device Stores DB/MQTT Record**
   - After receipt, persist `canonical_reading_hash` and the originating `tx_hash` with the telemetry payload.

4. **ğŸ›¡ï¸ Engine Validates Anti-Replay**
   - `ErgonEnergy` checks its anti-replay mapping and rejects duplicates.

5. **ğŸ“¢ Engine Emits Audit Events**
   - `ErgonEnergy` emits events that include:
     - The anchor (`canonical_reading_hash`)
     - The measured inputs (produced/exported)
     - Derived allocations / rule flags
     - Minted token quantities

6. **ğŸª™ Engine Mints Tokens**
   - `ErgonEnergy` calls token contracts:
     - `Ergon.increaseSupply(user_or_device, ergonAmount)`
     - `Carbon.increaseSupply(user_or_device, carbonAmount)`

</details>

<div style="background-color:#f3e5f5; padding:15px; border-radius:8px; border-left:4px solid #9b59b6; margin:20px 0;">
<strong>ğŸ’­ Interpretation:</strong> "This amount of <span style="color:#9b59b6"><strong>CARBON</strong></span> exists because this specific <code>canonical_reading_hash</code> was accepted and allocated by the engine."
</div>

---

## ğŸ“¢ 5. What to Emit On-Chain (And Why)

Auditors need evidence that:

- âœ… Readings existed
- âœ… Readings were not replayed
- âœ… Minting was derived from readings
- âœ… Later burns (for certificates) correspond to real minted supply

### 5.1 Minimum Event Set (Recommended)

For each accepted reading, emit one canonical engine audit event (e.g., <code style="color:#9b59b6"><strong>ReadingAccepted</strong></code>):

**Benefits of This Approach:**

<table style="width:100%; border-collapse:collapse; margin:20px 0;">
<tr style="background-color:#2d8cff; color:white;">
    <th style="padding:10px; text-align:left;">Benefit</th>
    <th style="padding:10px; text-align:left;">Description</th>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:10px;"><strong>ğŸ”„ Reconstruction</strong></td>
    <td style="padding:10px;">Enables reconstruction of supply provenance per reading</td>
</tr>
<tr>
    <td style="padding:10px;"><strong>ğŸ’¾ Storage Efficiency</strong></td>
    <td style="padding:10px;">No need to store raw telemetry on-chain</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:10px;"><strong>ğŸ”— Linkage</strong></td>
    <td style="padding:10px;">Engine event ties mint amounts to <code>canonical_reading_hash</code></td>
</tr>
<tr>
    <td style="padding:10px;"><strong>ğŸ“Š ERC-20 Compatible</strong></td>
    <td style="padding:10px;">Standard <code>Transfer(0x0 â†’ to, amount)</code> logs still emitted</td>
</tr>
</table>

**Example Solidity Event:**

```solidity
event ReadingAccepted(
    address indexed device,
    uint256 indexed timestamp_slot,
    bytes32 indexed canonical_reading_hash,
    uint256 produced,
    uint256 exported,
    uint256 factor,
    uint256 ergon_minted,
    uint256 carbon_minted,
    uint8 reason_code  // Optional: rule flags
);
```

### 5.2 Why Not "Minute Lots" On-Chain

<div style="background-color:#fff3e0; padding:15px; border-radius:8px; border-left:4px solid #f39c12; margin:20px 0;">
<strong>âš ï¸ Common Failure Mode:</strong> Bridge slowdowns occur when too much fine-grained provenance is pushed into the bridged representation.
</div>

An auditor typically **does not require** "minute provenance on the bridged chain". Instead, they require:

- âœ… Proof that the source chain contains immutable anchors
- âœ… A provable mapping from certificate retirement (burn) â†’ subset of those anchors

**So:**

- ğŸ“Œ Keep minute anchors in the source chain + DB
- ğŸ“Š Optionally aggregate into period commitments (daily/monthly) for fast proofs
- ğŸŒ‰ Bridge only ERC-20 balances for UX

---

## âš¡ 6. Provenance Model That Stays Fast for Users

The design targets:

<table style="width:100%; margin:20px 0;">
<tr>
<td width="33%" style="background-color:#e3f2fd; padding:20px; text-align:center;">
    <h3>ğŸš€ Fast Transfers</h3>
    <p>Real-time bridging without provenance overhead</p>
</td>
<td width="33%" style="background-color:#e8f5e9; padding:20px; text-align:center;">
    <h3>ğŸ“‰ Minimal On-Chain Data</h3>
    <p>Only what's sufficient for audit</p>
</td>
<td width="33%" style="background-color:#f3e5f5; padding:20px; text-align:center;">
    <h3>ğŸ¯ Device Proof at Mint</h3>
    <p>Prove contributions at certificate time</p>
</td>
</tr>
</table>

### 6.1 Correct Mental Model: Balances Move, Provenance Stays Anchored

<div style="background-color:#e7f3ff; padding:20px; border-radius:10px; border:2px solid #2d8cff; margin:20px 0;">

<h4>ğŸ§  Key Concept</h4>

<p>ERC-20 transfers <strong>do not need to "move provenance lots"</strong>. Provenance is not "which user owns which reading"; provenance is "what evidence created this supply".</p>

<p><strong>Model:</strong></p>
<ul>
<li>âœ… Source chain stores immutable reading anchors/events</li>
<li>âœ… <span style="color:#9b59b6"><strong>CARBON</strong></span> token supply exists because those anchors existed</li>
<li>âœ… Users can trade <span style="color:#9b59b6"><strong>CARBON</strong></span> freely</li>
<li>âœ… When minting an NFT certificate (burning <span style="color:#9b59b6"><strong>CARBON</strong></span>), generate an audit proof showing the burned amount is covered by a set of anchors (or period commitments)</li>
</ul>

</div>

---

## ğŸŒ³ 7. Period Commitments (Optional But Powerful)

This is the **"middle layer"** between minute anchors and certificate proofs.

### 7.1 What `commitDevicePeriod(device, periodId, periodSum, periodRoot)` Means

For a device and a period (day/week/month), compute:

<table style="width:100%; margin:20px 0;">
<tr>
<td width="50%" style="background-color:#e8f5e9; padding:20px;">
    <h4>ğŸ“Š <code>periodSum</code></h4>
    <p>Total carbon minted for that device in that period (or total kWh / total carbon delta)</p>
</td>
<td width="50%" style="background-color:#e3f2fd; padding:20px;">
    <h4>ğŸŒ³ <code>periodRoot</code></h4>
    <p>A Merkle root over all reading anchors, typically leaves such as <code>(canonical_reading_hash, carbon_amount)</code></p>
</td>
</tr>
</table>

Store these commitments on-chain (mapping + event), typically in mappings like:

```solidity
mapping(address => mapping(uint256 => DevicePeriodCommit)) public devicePeriodCommit;

struct DevicePeriodCommit {
    uint256 sum;
    bytes32 root;
}
```

**Merkle Tree Structure:**

```mermaid
graph TD
    A[Global Period Root] --> B[Device A Commitment]
    A --> C[Device B Commitment]
    A --> D[Device C Commitment]
    B --> E[Reading 1]
    B --> F[Reading 2]
    B --> G[Reading 3]
    C --> H[Reading 4]
    C --> I[Reading 5]
    D --> J[Reading 6]
    D --> K[Reading 7]
    
    style A fill:#9b59b6,color:#fff
    style B fill:#2ecc71,color:#fff
    style C fill:#2ecc71,color:#fff
    style D fill:#2ecc71,color:#fff
    style E fill:#3498db,color:#fff
    style F fill:#3498db,color:#fff
    style G fill:#3498db,color:#fff
    style H fill:#3498db,color:#fff
    style I fill:#3498db,color:#fff
    style J fill:#3498db,color:#fff
    style K fill:#3498db,color:#fff
```

### 7.2 What `commitPeriodGlobal(periodId, globalRoot)` Means

For a given period, compute a Merkle root over all device commitments for that period (e.g., leaves are `(device, sum, root)`). Then store:

```solidity
mapping(uint256 => bytes32) public globalCommit;

function commitPeriodGlobal(uint256 periodId, bytes32 globalRoot) external {
    globalCommit[periodId] = globalRoot;
    emit PeriodGlobalCommitted(periodId, globalRoot, block.timestamp);
}
```

<div style="background-color:#e8f5e9; padding:15px; border-radius:8px; border-left:4px solid #2ecc71; margin:20px 0;">
<strong>âœ… Verification Path:</strong> An auditor can now verify:
<ul>
<li>The certificate burn was covered by a set of device periods</li>
<li>Each device period is covered by a set of per-reading anchors (if needed)</li>
</ul>
</div>

### 7.3 Should This Be Executed Automatically When the Period Elapses?

<div style="background-color:#fff3e0; padding:15px; border-radius:8px; border-left:4px solid #f39c12; margin:20px 0;">
<strong>âš ï¸ Important:</strong> EVM contracts do not self-trigger when time passes.
</div>

So "automatic" must be **off-chain** (cron job / relayer / keeper bot). A typical pattern:

1. ğŸ• **Relayer wakes** every N minutes/hours
2. ğŸ“… **Detects** a period boundary
3. ğŸ§® **Computes** commits (from DB/indexer)
4. ğŸ“¤ **Calls** `commitDevicePeriod` and `commitPeriodGlobal`

---

## ğŸŒ‰ 8. Bridging: Keep It Agnostic to Lots/Periods (Best for UX)

### 8.1 Do We Need to Sync Period Commits to Destination Chain Periodically?

**Not strictly.** Two common options:

<table style="width:100%; margin:20px 0;">
<tr>
<td width="50%" style="background-color:#d4edda; padding:20px;">
    <h4>âœ… Option A â€” No Periodic Sync</h4>
    <p><strong style="color:#2ecc71">SIMPLEST UX</strong></p>
    <ul>
        <li>Bridge only moves ERC-20 balances</li>
        <li>Destination chain treats source chain as provenance authority</li>
        <li>When NFT certificate is minted (destination or source), fetch proofs from source (or DB/indexer)</li>
        <li>Embed proof/roots into NFT metadata / certificate events</li>
    </ul>
    <p><strong>âœ… Best for:</strong> Fast and frictionless user experience</p>
</td>
<td width="50%" style="background-color:#fff3cd; padding:20px;">
    <h4>âš™ï¸ Option B â€” Periodic Sync</h4>
    <p><strong style="color:#f39c12">SELF-CONTAINED DESTINATION</strong></p>
    <ul>
        <li>Relayer periodically sends <code>(periodId, globalRoot)</code></li>
        <li>Optionally includes device commits to destination</li>
        <li>Destination contract stores these roots</li>
        <li>NFT mint on destination can verify proofs against stored roots without querying source</li>
    </ul>
    <p><strong>âš™ï¸ Best for:</strong> Regulator requirements for destination-chain self-verification</p>
</td>
</tr>
</table>

<div style="background-color:#e7f3ff; padding:15px; border-radius:8px; border-left:4px solid #2d8cff; margin:20px 0;">
<strong>ğŸ’¡ Recommendation:</strong> If the priority is "fast and frictionless", <strong>Option A</strong> is usually sufficient unless a regulator explicitly requires destination-chain self-verification.
</div>

### 8.2 What Does Destination Need During `bridgeMint`?

If the destination token represents bridged <span style="color:#9b59b6"><strong>CARBON</strong></span> balance, it **does not need device lists at mint time**.

It typically only needs:

<table style="width:100%; border-collapse:collapse; margin:20px 0;">
<tr style="background-color:#2d8cff; color:white;">
    <th style="padding:10px; text-align:left;">Parameter</th>
    <th style="padding:10px; text-align:left;">Purpose</th>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:8px;"><code>messageId</code></td>
    <td style="padding:8px;">Cross-chain message identifier</td>
</tr>
<tr>
    <td style="padding:8px;"><code>recipient</code></td>
    <td style="padding:8px;">Destination address for minted tokens</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:8px;"><code>amount</code></td>
    <td style="padding:8px;">Token amount to mint</td>
</tr>
<tr>
    <td style="padding:8px;"><code>proof</code> (optional)</td>
    <td style="padding:8px;">ZK or gateway proof for bridge authentication</td>
</tr>
</table>

**Example Solidity Function:**

```solidity
function bridgeMint(
    bytes32 messageId,
    address recipient,
    uint256 amount,
    bytes calldata proof
) external onlyBridge {
    require(verifyProof(messageId, proof), "Invalid bridge proof");
    _mint(recipient, amount);
    emit BridgeMinted(messageId, recipient, amount);
}
```

<div style="background-color:#f3e5f5; padding:15px; border-radius:8px; border-left:4px solid #9b59b6; margin:20px 0;">
<strong>ğŸ“ Note:</strong> Provenance proofs can be handled later at certificate mint / retirement time.
</div>

---

## ğŸ”— 9. Stronger Provenance with Hash Chaining (Optional Upgrade)

To detect missing readings (even off-chain), add:

<table style="width:100%; margin:20px 0;">
<tr>
<td width="50%" style="background-color:#e8f5e9; padding:20px;">
    <h4>ğŸ”¢ <code>seq</code></h4>
    <p>Monotonic counter per device</p>
    <p>Ensures sequential ordering and detects gaps</p>
</td>
<td width="50%" style="background-color:#e3f2fd; padding:20px;">
    <h4>â›“ï¸ <code>prev_hash</code></h4>
    <p>Hash of previous reading</p>
    <p>Creates tamper-evident chain linkage</p>
</td>
</tr>
</table>

Then each reading anchor commits to a chain:

**Chaining Formula:**

```solidity
canonical_reading_hash_t = keccak256(
    abi.encodePacked(
        device,
        timestamp,
        produced,
        exported,
        factor,
        seq,           // Sequential number
        prev_hash_t_1  // Previous reading hash
    )
);
```

**Sequential Hash Chain Visualization:**

```mermaid
graph LR
    A[Reading 1<br/>seq=1<br/>prev=0x0] -->|hash1| B[Reading 2<br/>seq=2<br/>prev=hash1]
    B -->|hash2| C[Reading 3<br/>seq=3<br/>prev=hash2]
    C -->|hash3| D[Reading 4<br/>seq=4<br/>prev=hash3]
    D -->|hash4| E[Reading 5<br/>seq=5<br/>prev=hash4]
    
    style A fill:#3498db,color:#fff
    style B fill:#2ecc71,color:#fff
    style C fill:#9b59b6,color:#fff
    style D fill:#f39c12,color:#fff
    style E fill:#e74c3c,color:#fff
```

<div style="background-color:#e8f5e9; padding:15px; border-radius:8px; border-left:4px solid #2ecc71; margin:20px 0;">
<strong>âœ… Result:</strong> This makes gaps or tampering detectable <strong>even if a record is deleted from the DB</strong>.
</div>

---

## ğŸ“‹ 10. Summary

<div style="background-color:#e7f3ff; padding:20px; border-radius:10px; border:2px solid #2d8cff; margin:20px 0;">

Each meter interval is anchored using a deterministic <code>canonical_reading_hash</code> computed from a canonicalized payload (device identifier, epoch time slot, measured production/export values, and allocation factor). 

The device submits the <code>canonical_reading_hash</code> to the on-chain energy engine (<code style="color:#9b59b6"><strong>ErgonEnergy</strong></code>) together with the measured deltas. 

The engine enforces anti-replay and emits immutable audit events binding each accepted reading to the derived allocations and token mint amounts. 

The same <code>canonical_reading_hash</code> is persisted in MQTT/DB alongside the transaction metadata, enabling deterministic cross-verification between off-chain telemetry and on-chain state transitions. 

This keeps detailed per-minute telemetry off-chain for scale, while keeping on-chain evidence sufficient for audit.

</div>

---

## âœ… 11. Quick Answers

<details>
<summary><strong>â“ Is <code>canonical_reading_hash</code> enough?</strong></summary>

<br/>

**Yes**, if it is:

- âœ… **Deterministic** (typed + normalized)
- âœ… **Stored in DB** alongside the raw reading and tx metadata
- âœ… **Referenced by an on-chain audit event** that ties it to mint/burn outcomes

</details>

---

## ğŸ“š 12. Glossary

<details>
<summary><strong>ğŸ“– Click to Expand: Complete Terminology Reference</strong></summary>

<br/>

<table style="width:100%; border-collapse:collapse;">
<tr style="background-color:#2d8cff; color:white;">
    <th style="padding:10px; text-align:left; width:30%;">Term</th>
    <th style="padding:10px; text-align:left;">Definition</th>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:10px;"><code>canonical_reading_hash</code></td>
    <td style="padding:10px;">A deterministic <code>bytes32</code> anchor (typically <code>keccak256</code>) computed from a canonical reading envelope. Used as the cross-system join key for telemetry records, EVM transactions, and engine audit events.</td>
</tr>
<tr>
    <td style="padding:10px;"><strong>Reading envelope</strong></td>
    <td style="padding:10px;">The canonical set of fields hashed to produce <code>canonical_reading_hash</code> (e.g., normalized <code>device_id</code>, <code>timestamp_slot</code>, <code>produced/exported</code>, <code>factor</code>, and a schema/version marker).</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:10px;"><code>timestamp_slot</code></td>
    <td style="padding:10px;">The reading time represented as an integer slot (commonly "epoch minute") to avoid ambiguity.</td>
</tr>
<tr>
    <td style="padding:10px;"><strong>Engine audit event</strong></td>
    <td style="padding:10px;">A contract event emitted by <code>ErgonEnergy</code> that ties an accepted reading anchor to derived allocations and mint/burn outcomes.</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:10px;"><strong>Anti-replay</strong></td>
    <td style="padding:10px;">A contract rule that rejects a previously-seen reading anchor (e.g., using a <code>usedReading</code> mapping).</td>
</tr>
<tr>
    <td style="padding:10px;"><code>periodId</code></td>
    <td style="padding:10px;">A period identifier (day/week/month) used for aggregating per-minute anchors into period commitments.</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:10px;"><code>periodSum</code></td>
    <td style="padding:10px;">The aggregate amount for a device over a period (e.g., total CARBON minted).</td>
</tr>
<tr>
    <td style="padding:10px;"><code>periodRoot</code></td>
    <td style="padding:10px;">A Merkle root committing to all per-reading anchors in a period (often leaves like <code>(canonical_reading_hash, carbon_amount)</code>).</td>
</tr>
<tr style="background-color:#f5f5f5;">
    <td style="padding:10px;"><code>globalRoot</code></td>
    <td style="padding:10px;">A Merkle root committing to all device period commitments for a period (often leaves like <code>(device, sum, root)</code>).</td>
</tr>
</table>

</details>

---

<div align="center" style="background-color:#2d8cff; padding:30px; border-radius:15px; margin:30px 0;">
    <h2 style="color:white; margin:0;">ğŸš€ Ready to Build Trustless Energy Systems</h2>
    <p style="color:white; margin:10px 0;">Empowering transparent, auditable, and scalable energy token infrastructure</p>
    <br/>
    <img src="https://img.shields.io/badge/Solidity-0.8+-blue?logo=solidity" />
    <img src="https://img.shields.io/badge/Web3-Ready-purple?logo=ethereum" />
    <img src="https://img.shields.io/badge/Open-Source-green?logo=github" />
    <img src="https://img.shields.io/badge/Audit-Friendly-orange?logo=shield" />
</div>

<div align="center">
    <strong>Made with â¤ï¸ by the Serenity Energy Team</strong>
    <br/>
    <a href="https://github.serenity.energy">ğŸ“– Documentation</a> â€¢ 
    <a href="https://github.com/serenitysource">ğŸ’» GitHub</a> â€¢ 
    <a href="https://github.serenity.energy/support">ğŸ¤ Support</a>
</div>
